<!doctype html><html lang=en-us><head><title>Fun with php deployer and ssh - Azuka</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Azuka"><meta property="og:url" content="https://azuka.github.io/posts/post-0004-fun-with-the-ssh-a-flag/"><meta property="og:site_name" content="Azuka"><meta property="og:title" content="Fun with php deployer and ssh"><meta property="og:description" content="A long, long time ago when my daily driver was a Windows machine, I used to deploy websites over ftp, then sftp. I remember SmartFTP being one of the first software tools I ever purchased.
In time (around 2011), I got introduced to Capistrano when I started doing continuous integration/delivery and setting up multiple environments for my projects.
Getting a consistent ruby ecosystem working for mostly php projects was annoying as I moved between Jenkins, Wercker (pre-Oracle), Shippable (before they got acquired by JFrog) and finally CircleCI."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-19T23:37:38-08:00"><meta property="article:modified_time" content="2022-12-19T23:37:38-08:00"><meta property="article:tag" content="Ssh"><meta property="article:tag" content="Deployerphp"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fun with php deployer and ssh"><meta name=twitter:description content="A long, long time ago when my daily driver was a Windows machine, I used to deploy websites over ftp, then sftp. I remember SmartFTP being one of the first software tools I ever purchased.
In time (around 2011), I got introduced to Capistrano when I started doing continuous integration/delivery and setting up multiple environments for my projects.
Getting a consistent ruby ecosystem working for mostly php projects was annoying as I moved between Jenkins, Wercker (pre-Oracle), Shippable (before they got acquired by JFrog) and finally CircleCI."><meta name=generator content="Hugo 0.125.6"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://azuka.github.io/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=/css/styles.css></head><body><div id=container><header><h1><a href=/>Azuka</a></h1><ul id=social-media><li><a href=https://github.com/Azuka title=GitHub><i class="fab fa-github fa-lg"></i></a></li><li><a href=https://gitlab.com/Azuka title=GitLab><i class="fab fa-gitlab fa-lg"></i></a></li><li><a href=https://twitter.com/zahymaka title=Twitter><i class="fab fa-twitter fa-lg"></i></a></li><li><a href=https://linkedin.com/in/Azuka title=LinkedIn><i class="fab fa-linkedin fa-lg"></i></a></li><li><a href=https://stackoverflow.com/users/66688/zahymaka title=StackOverflow><i class="fab fa-stack-overflow fa-lg"></i></a></li></ul><p><em>I like to tinker with things</em></p></header><nav><ul><li><a class=active href=/posts/><i class="fa-li fa fa-lg"></i><span>Posts</span></a></li></ul></nav><main><article><h1>Fun with php deployer and ssh</h1><aside><ul><li><time class=post-date datetime=2022-12-19T23:37:38-08:00>Dec 19, 2022</time></li><li><em><a href=/tags/ssh>#ssh</a>
,
<a href=/tags/deployerphp>#deployerphp</a></em></li><li>3 minute read</li></ul></aside><p>A long, long time ago when my daily driver was a Windows machine,
I used to deploy websites over ftp, then sftp. I remember SmartFTP being one of the first
software tools I ever purchased.</p><p>In time (around 2011), I got introduced to <a href=https://capistranorb.com/>Capistrano</a> when I started doing continuous integration/delivery and setting up multiple environments for my projects.</p><p>Getting a consistent ruby ecosystem working for mostly php projects was annoying as I moved between Jenkins, Wercker (pre-Oracle), Shippable (before they got acquired by JFrog) and finally CircleCI. I did have Ruby dependencies because <a href=https://github.com/Compass/compass>Compass</a> was all the rage, but eventually, it became annoying as browsers stopped needing prefixes, and Sass got ported to other languages.</p><p>I started doing deploys somewhat like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>- <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$BRANCH<span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;master&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> ssh -t $DEPLOY_USER@$DEPLOY_HOST <span style=color:#e6db74>&#34;cd ~/app_staging &amp;&amp; git fetch --all &amp;&amp; git checkout --force </span>$COMMIT<span style=color:#e6db74> &amp;&amp; php composer.phar install --no-dev --optimize-autoloader&#34;</span> <span style=color:#f92672>&amp;&amp;</span> grunt; curl -H <span style=color:#e6db74>&#34;x-api-key:xxxx&#34;</span>  -d <span style=color:#e6db74>&#34;deployment[app_name]=App-other&#34;</span> -d <span style=color:#e6db74>&#34;deployment[description]=This deployment can be viewed at </span><span style=color:#e6db74>${</span>BUILD_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -d <span style=color:#e6db74>&#34;deployment[revision]=</span><span style=color:#e6db74>${</span>COMMIT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -d <span style=color:#e6db74>&#34;deployment[changelog]=</span><span style=color:#e6db74>${</span>SHIPPABLE_BUILD_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -d <span style=color:#e6db74>&#34;deployment[user]=</span><span style=color:#e6db74>${</span>USER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> https://api.newrelic.com/deployments.xml; <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>- <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$BRANCH<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;master&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> ssh -t $DEPLOY_USER@$DEPLOY_HOST <span style=color:#e6db74>&#34;cd ~/app_system &amp;&amp; git fetch --all &amp;&amp; git checkout --force </span>$COMMIT<span style=color:#e6db74> &amp;&amp; php composer.phar install --no-dev --optimize-autoloader&#34;</span> <span style=color:#f92672>&amp;&amp;</span> grunt; curl -H <span style=color:#e6db74>&#34;x-api-key:xxxx&#34;</span>  -d <span style=color:#e6db74>&#34;deployment[app_name]=App-production&#34;</span> -d <span style=color:#e6db74>&#34;deployment[description]=This deployment can be viewed at </span><span style=color:#e6db74>${</span>BUILD_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -d <span style=color:#e6db74>&#34;deployment[revision]=</span><span style=color:#e6db74>${</span>COMMIT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -d <span style=color:#e6db74>&#34;deployment[changelog]=</span><span style=color:#e6db74>${</span>SHIPPABLE_BUILD_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -d <span style=color:#e6db74>&#34;deployment[user]=</span><span style=color:#e6db74>${</span>USER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> https://api.newrelic.com/deployments.xml; <span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>I missed capistrano multistage though, because there was no easy way to roll back deployments other than manually, and on projects where I had to deploy to multiple servers, this became unwieldy very quickly.</p><p>Enter <a href=https://deployer.org>deployer</a>.</p><p>It had an API that reminded me of Capistrano: multiple hosts and stages, with support for custom tasks and symlinked releases that didn&rsquo;t get swapped until deployment completion.</p><p>I started at v3 and have gone through 4 major version upgrades with <a href=https://github.com/deployphp/deployer/pull/1160>some</a> <a href=https://github.com/deployphp/deployer/issues/1156>battle</a> <a href=https://github.com/deployphp/deployer/issues/3337>scars</a> to show.</p><p>The latest one was a simple task definition which I used to keep secrets pulled from a separate repo (admittedly not a very good idea, but one that works for now):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>task</span>(<span style=color:#e6db74>&#39;env:secrets&#39;</span>, <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run</span>(<span style=color:#e6db74>&#39;(cd ~/.env-secrets &amp;&amp; git pull)&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>})<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>desc</span>(<span style=color:#e6db74>&#39;Pull secret files.&#39;</span>);
</span></span></code></pre></div><p>I kept getting a fatal pull error even though I could ssh into all the affected servers and literally run <code>(cd ~/.env-secrets && git pull)</code> without any problems. I could also run the deploy command locally without any issues, ie:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./vendor/bin/dep env:secrets stage<span style=color:#f92672>=</span>staging --revision<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>git rev-parse HEAD<span style=color:#66d9ef>)</span> -vvv
</span></span></code></pre></div><p>Using CircleCI&rsquo;s ssh mode to troubleshoot got me nothing. Cue the dreaded list of CI git commits a la <code>try deploy x16</code>.</p><p>I fix CI systems at work quite a bit, and in almost every case, the problem is right there in the terminal output, so it was quite ironic when I took a closer look and saw:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh <span style=color:#e6db74>&#39;-F&#39;</span> <span style=color:#e6db74>&#39;/home/circleci/.ssh/config&#39;</span> <span style=color:#e6db74>&#39;-A&#39;</span> <span style=color:#e6db74>&#39;-o&#39;</span> <span style=color:#e6db74>&#39;ControlMaster=auto&#39;</span> <span style=color:#e6db74>&#39;-o&#39;</span> <span style=color:#e6db74>&#39;ControlPersist=60&#39;</span> <span style=color:#e6db74>&#39;-o&#39;</span> <span style=color:#e6db74>&#39;ControlPath=/dev/shm/***@****&#39;</span> <span style=color:#e6db74>&#39;***@****&#39;</span> <span style=color:#e6db74>&#39;: 34bf7dc0417ecfc06846; bash -ls&#39;</span>
</span></span></code></pre></div><p>Using those ssh args, and running a git pull, I got the expected fatal error: bingo!</p><p>After reading the <em>fine</em> manual and narrowing the culprit to <a href=https://superuser.com/questions/1376111/with-ssh-what-does-the-a-flag-do>the -A flag</a>, it was as simple as updating the task to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>task</span>(<span style=color:#e6db74>&#39;env:secrets&#39;</span>, <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run</span>(<span style=color:#e6db74>&#39;SSH_AUTH_SOCK=&#34;&#34; (cd ~/.env-secrets &amp;&amp; git pull)&#39;</span>);
</span></span><span style=display:flex><span>})<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>desc</span>(<span style=color:#e6db74>&#39;Pull secret files.&#39;</span>);
</span></span></code></pre></div><p>Deployer does have a <code>->setForwardAgent(false)</code> host flag, but 4 major upgrades have taught me not to mess too much with the internals when they <em>just</em> work.</p><p>As always, it&rsquo;s the little things that cost you hours of debugging, especially when your internet is spotty.</p></article><section class=post-nav><ul><li><a href=https://azuka.github.io/posts/post-0003-a-billing-problem/><i class="fa fa-chevron-circle-left"></i> A billing problem based on assumptions</a></li><li><a href=https://azuka.github.io/posts/post-0005-at-gophercon/>At GopherCon <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><h6>|
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://azuka.github.io/index.xml>Subscribe</a></h6></footer></div><script src=/js/scripts.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XGCYPWQ1NS"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XGCYPWQ1NS")}</script></body></html>